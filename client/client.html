<!DOCTYPE html>
<html lang="en">
<head>
    <title>Notes</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <!-- Embed google fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Permanent+Marker&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">
        // function to parse JSON response 
        const parseJSON = (xhr, content) => {
            if(xhr.response) {
                const obj = JSON.parse(xhr.response);
                //console.log(obj);
                if(xhr.status === 200) {
                    //console.log(obj.notes);
                    Object.values(obj).forEach(function(data) {
                        Object.values(data).forEach(function (d) {
                            console.log(d);
                            
                            const notepad = document.querySelector('#notepad');
                            const p = document.createElement('p');
                            const h3 = document.createElement('h3');
                            const ul = document.createElement('ul');
                            const li = document.createElement('li');
                            const div = document.createElement('div');

                            div.className = 'note';
                            if(d.color === 'Orange') {
                                div.style.borderColor = "#DB8C53";
                            }
                            if(d.color === 'Purple') {
                                div.style.borderColor = "#AA89D9";
                            }
                            if(d.color === 'Red') {
                                div.style.borderColor = "#DB6561";
                            }
                            if(d.color === 'Green') {
                                div.style.borderColor = "#84C289";
                            }
                            if(d.color === 'Pink') {
                                div.style.borderColor = "#F280BF";
                            }
                            if(d.color === 'Blue') {
                                div.style.borderColor = "#61A2C2";
                            }
                            p.textContent = d.note;
                            h3.textContent = d.title;
                            notepad.appendChild(div);
                            div.appendChild(h3);
                            li.appendChild(p);
                            ul.appendChild(li);
                            div.appendChild(ul);
                        });
                    });
                    //console.log(obj.notes);
                    //content.innerHTML += `<p>${xhr.response}</p>`;
                }
            }
        };
        const handleResponse = (xhr, parseResponse) => {
            
            const notepad = document.querySelector('#notepad');
            const alert = document.querySelector('#alert');
            const msg = document.querySelector('#msg');
            
            switch(xhr.status) {
                case 200:
                    break;
                case 201: // created
                    msg.innerHTML = `Note Added.`;
                    alert.style.display = "inline-block";
                    alert.style.backgroundColor = "#4CAF50";
                    break;
                case 204: // updated
                    msg.innerHTML = `Note Updated.`;
                    alert.style.display = "inline-block";
                    alert.style.backgroundColor = "#4CAF50";
                    break;
                case 400: // bad request
                    msg.innerHTML = `Title and note are both required.`;
                    alert.style.display = "inline-block";
                    alert.style.backgroundColor = "#f44336";
                    break;
                case 404: // not found
                    notepad.innerHTML = '<b>Resource Not Found</b>';
                    break;
                default: // any other status
                    msg.innerHTML = `${obj.message}`;
                    alert.style.display = "inline-block";
                    alert.style.backgroundColor = "#2196F3";
                    break;
                }

            parseJSON(xhr, notepad);
        };
        const sendPost = (e, noteForm) => {
            
            const noteAction = noteForm.getAttribute('action');
            const noteMethod = noteForm.getAttribute('method');

            const noteField = noteForm.querySelector('#noteField');
            const titleField = noteForm.querySelector('#titleField');
            const colorSelect = noteForm.querySelector('#color');

            const xhr = new XMLHttpRequest();
            xhr.open(noteMethod, noteAction);

            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('Accept', 'application/json');

            xhr.onload = () => handleResponse(xhr);

            const formData = `title=${titleField.value}&note=${noteField.value}&color=${colorSelect.value}`;

            xhr.send(formData);

            e.preventDefault();
            return false;
        };

        const requestUpdate = (e, getNotes) => {

            const getNotesAction = getNotes.getAttribute('action');
            const getNotesMethod = getNotes.getAttribute('method');

            const xhr = new XMLHttpRequest();

            xhr.open(getNotesMethod, getNotesAction);

            xhr.setRequestHeader('Accept', 'application/json');

            if(getNotesMethod == 'get'){
            xhr.onload = () => handleResponse(xhr, true);
            } else {
                xhr.onload = () => handleResponse(xhr, false);
            }

            xhr.send();

            e.preventDefault();
            
            return false;
        };

        const init = () => {
            
            const noteForm = document.querySelector('#noteForm');
            const getForm = document.querySelector('#get_notes_form');

            const getNotes = (e) => requestUpdate(e, getForm);
            const addNote = (e) => sendPost(e, noteForm);
            
            noteForm.addEventListener('submit', addNote);
            getForm.addEventListener('click', getNotes);
        };

        window.onload = init;
    </script>
</head>
<body>
    <div id="title">
    <h1>Notes</h1>
    </div>
    <div id="head">
        <form id="noteForm" action="/addNote" method="post">
            <label for="title">Title: </label>
            <input id="titleField" type="text" name="title" autofocus placeholder="Start typing..."/>
            <label for="note">Add a note: </label>
            <input id="noteField" type="text" name="note" autofocus placeholder="Start typing..."/>
            <label for="color">Color: </label>
            <select id="color" name="color">
                <option>Orange</option>
                <option>Purple</option>
                <option>Blue</option>
                <option>Red</option>
                <option>Green</option>
                <option>Pink</option>
            </select>
            <input type="submit" value="+" />
        </form>
        <div id="alert">
            <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
            <span id="msg"></span>
        </div>
    </div>
    <div id="content">
        <div id="header">
            <form id="get_notes_form" action="/getNotes" method="get">
            <button id="get_notes">Get Notes</button>
            </form>
        </div>
        <div id="notepad">

        </div>
    </div>
</body>
</html>